{% extends 'base.html' %}

{% block title %}Medicine Details - {{ medicine.name }} - HMS{% endblock %}
{% block page_title %}Medicine Details{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-pills text-success me-2"></i>
                {{ medicine.name }}
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'pharmacy:medicine_list' %}">Pharmacy</a></li>
                    <li class="breadcrumb-item active">{{ medicine.medicine_id }}</li>
                </ol>
            </nav>
        </div>
        <div>
            {% if medicine.is_low_stock %}
            <span class="badge bg-danger fs-5 px-3 py-2">
                <i class="fas fa-exclamation-triangle me-1"></i> Low Stock
            </span>
            {% else %}
            <span class="badge bg-success fs-5 px-3 py-2">
                <i class="fas fa-check-circle me-1"></i> In Stock
            </span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Medicine Information Card -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Medicine Information
                    </h5>
                    <span class="badge bg-white text-success">{{ medicine.medicine_id }}</span>
                </div>
                <div class="card-body">
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-id-badge me-1"></i> Medicine ID
                            </h6>
                            <p class="h5 mb-0">{{ medicine.medicine_id }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-capsules me-1"></i> Medicine Name
                            </h6>
                            <p class="h5 mb-0">{{ medicine.name }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-tag me-1"></i> Category
                            </h6>
                            <p class="mb-0"><span class="badge bg-primary">{{ medicine.category }}</span></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-industry me-1"></i> Manufacturer
                            </h6>
                            <p class="mb-0">{{ medicine.manufacturer }}</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Description -->
                    {% if medicine.description %}
                    <div class="mb-4">
                        <h6 class="text-success mb-2">
                            <i class="fas fa-clipboard me-2"></i>Description
                        </h6>
                        <div class="alert alert-info">
                            {{ medicine.description|linebreaks }}
                        </div>
                    </div>
                    <hr>
                    {% endif %}

                    <!-- Stock & Pricing Information -->
                    <h6 class="text-success mb-3">
                        <i class="fas fa-chart-line me-2"></i>Stock & Pricing Details
                    </h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Stock Quantity</h6>
                                    <h3 class="mb-0 {% if medicine.is_low_stock %}text-danger{% else %}text-success{% endif %}">
                                        {{ medicine.stock_quantity }}
                                    </h3>
                                    <small class="text-muted">{{ medicine.unit }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Reorder Level</h6>
                                    <h3 class="mb-0 text-warning">{{ medicine.reorder_level }}</h3>
                                    <small class="text-muted">{{ medicine.unit }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Purchase Price</h6>
                                    <h3 class="mb-0 text-info">৳{{ medicine.purchase_price }}</h3>
                                    <small class="text-muted">per {{ medicine.unit }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Selling Price</h6>
                                    <h3 class="mb-0 text-success">৳{{ medicine.selling_price }}</h3>
                                    <small class="text-muted">per {{ medicine.unit }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profit Margin -->
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-percentage me-2"></i><strong>Profit Margin:</strong></span>
                            <span class="h5 mb-0">{{ medicine.profit_margin|floatformat:2 }}%</span>
                        </div>
                    </div>

                    <hr>

                    <!-- Expiry Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-calendar-times me-1"></i> Expiry Date
                            </h6>
                            <p class="mb-0">
                                <span class="badge bg-warning text-dark">
                                    {{ medicine.expiry_date|date:"M d, Y" }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">
                                <i class="fas fa-cube me-1"></i> Unit
                            </h6>
                            <p class="mb-0"><span class="badge bg-info">{{ medicine.unit }}</span></p>
                        </div>
                    </div>

                    <!-- Timestamps -->
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Added: {{ medicine.created_at|date:"M d, Y h:i A" }}
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                <i class="fas fa-sync me-1"></i>
                                Last Updated: {{ medicine.updated_at|date:"M d, Y h:i A" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Management & Actions Card -->
        <div class="col-lg-4 mb-4">
            <!-- Stock Update Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-warehouse me-2"></i>
                        Stock Management
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Current Stock:</span>
                            <strong class="{% if medicine.is_low_stock %}text-danger{% else %}text-success{% endif %}">
                                {{ medicine.stock_quantity }} {{ medicine.unit }}
                            </strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Reorder Level:</span>
                            <strong class="text-warning">{{ medicine.reorder_level }} {{ medicine.unit }}</strong>
                        </div>
                    </div>

                    {% if medicine.is_low_stock %}
                    <div class="alert alert-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Low Stock Alert!</strong> Please reorder soon.
                    </div>
                    {% endif %}

                    <!-- Stock Update Form -->
                    <form method="post" action="{% url 'pharmacy:update_stock' medicine.pk %}" id="stockUpdateForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Action</label>
                            <select name="action" class="form-select" required>
                                <option value="add">Add Stock</option>
                                <option value="remove">Remove Stock</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Quantity</label>
                            <input type="number" 
                                   name="quantity" 
                                   class="form-control" 
                                   min="1"
                                   placeholder="Enter quantity"
                                   required>
                            <small class="text-muted">Current: {{ medicine.stock_quantity }} {{ medicine.unit }}</small>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sync-alt me-1"></i> Update Stock
                        </button>
                    </form>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'pharmacy:medicine_update' medicine.pk %}" class="btn btn-success">
                            <i class="fas fa-edit me-1"></i> Edit Medicine
                        </a>
                        <a href="{% url 'pharmacy:medicine_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to List
                        </a>
                        <hr>
                        <button onclick="deleteMedicine()" class="btn btn-outline-danger">
                            <i class="fas fa-trash me-1"></i> Delete Medicine
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
// Delete Medicine Function
function deleteMedicine() {
    if (confirm('Are you sure you want to delete this medicine? This action cannot be undone!')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "pharmacy:medicine_delete" medicine.pk %}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Stock Update Form Validation
document.getElementById('stockUpdateForm').addEventListener('submit', function(e) {
    const action = document.querySelector('select[name="action"]').value;
    const quantity = parseInt(document.querySelector('input[name="quantity"]').value);
    const currentStock = {{ medicine.stock_quantity }};
    
    if (quantity <= 0) {
        e.preventDefault();
        alert('Quantity must be greater than zero!');
        return false;
    }
    
    if (action === 'remove' && quantity > currentStock) {
        e.preventDefault();
        alert('Cannot remove more than current stock (' + currentStock + ' {{ medicine.unit }})!');
        return false;
    }
    
    const newStock = action === 'add' ? currentStock + quantity : currentStock - quantity;
    return confirm(`Are you sure you want to ${action} ${quantity} {{ medicine.unit }}?\nNew stock will be: ${newStock} {{ medicine.unit }}`);
});
</script>

<style>
.card.bg-light .card-body h3 {
    font-weight: bold;
}

@media print {
    .btn, .card-header, nav, .breadcrumb, form, hr:last-of-type, .col-lg-4 {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .col-lg-8 {
        width: 100% !important;
    }
}
</style>
{% endblock %}