{% extends 'base.html' %}

{% block title %}{% if is_update %}Update{% else %}Create{% endif %} Bill - HMS{% endblock %}
{% block page_title %}{% if is_update %}Update{% else %}Create New{% endif %} Bill{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-4">
        <h2><i class="fas fa-file-invoice-dollar text-success me-2"></i>{% if is_update %}Update Bill{% else %}Create New Bill{% endif %}</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'billing:bill_list' %}">Billing</a></li>
                <li class="breadcrumb-item active">{% if is_update %}Update{% else %}Create{% endif %}</li>
            </ol>
        </nav>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Bill Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="billForm">
                        {% csrf_token %}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Fill in the details below to {% if is_update %}update{% else %}create{% endif %} the bill. All amounts will be calculated automatically.
                        </div>
                        
                        <!-- Patient Selection with Quick Add -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Select Patient <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select name="patient" id="patient_select" class="form-select" required {% if is_update %}disabled{% endif %}>
                                    <option value="">-- Select Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.pk }}" {% if is_update and bill.patient.pk == patient.pk %}selected{% endif %}>
                                        {{ patient.patient_id }} - {{ patient.get_full_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if not is_update %}
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                                    <i class="fas fa-plus me-1"></i> New Patient
                                </button>
                                {% endif %}
                            </div>
                            <small class="text-muted">Select the patient for whom this bill is being generated</small>
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3 text-primary"><i class="fas fa-money-bill-wave me-2"></i>Bill Items</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user-md text-primary me-1"></i>
                                    Consultation Fee (৳)
                                </label>
                                <input type="number" name="consultation_fee" id="consultation_fee" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.consultation_fee }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Doctor consultation charges</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-pills text-success me-1"></i>
                                    Medicine Charges (৳)
                                </label>
                                <input type="number" name="medicine_charges" id="medicine_charges" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.medicine_charges }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Pharmacy/medicine costs</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-flask text-info me-1"></i>
                                    Lab Charges (৳)
                                </label>
                                <input type="number" name="lab_charges" id="lab_charges" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.lab_charges }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Laboratory test charges</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-ellipsis-h text-warning me-1"></i>
                                    Other Charges (৳)
                                </label>
                                <input type="number" name="other_charges" id="other_charges" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.other_charges }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Miscellaneous charges</small>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3 text-primary"><i class="fas fa-calculator me-2"></i>Adjustments</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-percent text-danger me-1"></i>
                                    Discount (৳)
                                </label>
                                <input type="number" name="discount" id="discount" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.discount }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Discount amount (if any)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-receipt text-info me-1"></i>
                                    Tax (৳)
                                </label>
                                <input type="number" name="tax" id="tax" 
                                       class="form-control bill-item" 
                                       value="{% if is_update %}{{ bill.tax }}{% else %}0{% endif %}"
                                       step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Tax amount (if applicable)</small>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3 text-success"><i class="fas fa-chart-line me-2"></i>Bill Summary</h6>
                        
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Consultation Fee</small>
                                        <div class="fw-bold" id="consultation_display">৳0.00</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Medicine Charges</small>
                                        <div class="fw-bold" id="medicine_display">৳0.00</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Lab Charges</small>
                                        <div class="fw-bold" id="lab_display">৳0.00</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Other Charges</small>
                                        <div class="fw-bold" id="other_display">৳0.00</div>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">Subtotal:</span>
                                    <span id="subtotal" class="fw-bold text-primary">৳0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Discount:</span>
                                    <span id="discount_display" class="text-danger">- ৳0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Tax:</span>
                                    <span id="tax_display" class="text-info">+ ৳0.00</span>
                                </div>
                                
                                <hr class="my-3">
                                
                                <div class="d-flex justify-content-between align-items-center bg-success text-white p-3 rounded">
                                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Total Amount:</h5>
                                    <h3 id="total_amount" class="mb-0">৳0.00</h3>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Payment Information (Only for Create) -->
                        {% if not is_update %}
                        <h6 class="mb-3 text-success"><i class="fas fa-wallet me-2"></i>Payment Information (Optional)</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-money-bill-wave text-success me-1"></i>
                                    Amount Received (৳)
                                </label>
                                <input type="number" 
                                       name="amount_paid" 
                                       id="amount_paid" 
                                       class="form-control" 
                                       value="0"
                                       step="0.01" 
                                       min="0" 
                                       placeholder="0.00">
                                <small class="text-muted">Amount paid by patient (if any)</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-credit-card text-info me-1"></i>
                                    Payment Method
                                </label>
                                <select name="payment_method" class="form-select">
                                    <option value="">-- Select Method --</option>
                                    <option value="CASH">Cash</option>
                                    <option value="CARD">Card</option>
                                    <option value="MOBILE">Mobile Banking</option>
                                    <option value="BANK">Bank Transfer</option>
                                </select>
                                <small class="text-muted">How payment was received</small>
                            </div>
                        </div>
                        
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Amount Paid:</span>
                                    <span id="paid_display" class="fw-bold text-success">৳0.00</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span><strong>Balance Due:</strong></span>
                                    <span id="balance_display" class="fw-bold text-danger">৳0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        {% endif %}
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-sticky-note text-warning me-1"></i>
                                Additional Notes
                            </label>
                            <textarea name="notes" class="form-control" rows="3" 
                                      placeholder="Enter any additional notes or comments about this bill...">{% if is_update %}{{ bill.notes }}{% endif %}</textarea>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Please review all amounts carefully before submitting.
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-1"></i>
                                {% if is_update %}Update Bill{% else %}Create Bill{% endif %}
                            </button>
                            <a href="{% url 'billing:bill_list' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            {% if is_update %}
                            <button type="button" class="btn btn-danger btn-lg ms-auto" onclick="if(confirm('Are you sure you want to delete this bill?')) window.location='{% url 'billing:bill_delete' bill.pk %}'">
                                <i class="fas fa-trash me-1"></i> Delete Bill
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Quick Tips Card -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Quick Tips</h6>
                </div>
                <div class="card-body bg-light">
                    <ul class="mb-0">
                        <li>All amounts are calculated automatically as you type</li>
                        <li>Subtotal = Consultation + Medicine + Lab + Other charges</li>
                        <li>Total = Subtotal - Discount + Tax</li>
                        <li>You can record payment during bill creation (optional)</li>
                        <li>Bills can be edited later from the billing list</li>
                        <li>Additional payments can be recorded after bill creation</li>
                        <li>Click "+ New Patient" to quickly add a patient</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="addPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPatientModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Add New Patient
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickPatientForm">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Quick patient registration. You can add more details later from the Patients section.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                            <input type="text" name="first_name" id="modal_first_name" class="form-control" required placeholder="Enter first name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
                            <input type="text" name="last_name" id="modal_last_name" class="form-control" required placeholder="Enter last name">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" name="email" id="modal_email" class="form-control" required placeholder="patient@example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Phone Number</label>
                            <input type="tel" name="phone_number" id="modal_phone" class="form-control" placeholder="+880 1XXX-XXXXXX">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Date of Birth <span class="text-danger">*</span></label>
                            <input type="date" name="date_of_birth" id="modal_dob" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Gender <span class="text-danger">*</span></label>
                            <select name="gender" id="modal_gender" class="form-select" required>
                                <option value="">-- Select Gender --</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Address</label>
                        <textarea name="address" id="modal_address" class="form-control" rows="2" placeholder="Patient address"></textarea>
                    </div>

                    <div id="patientFormMessage"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" id="savePatientBtn" class="btn btn-success" onclick="saveQuickPatient()">
                    <i class="fas fa-save me-1"></i> Save Patient
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Quick Patient Add Function
function saveQuickPatient() {
    const form = document.getElementById('quickPatientForm');
    const formData = new FormData(form);
    const messageDiv = document.getElementById('patientFormMessage');
    const saveBtn = document.getElementById('savePatientBtn');
    
    // Disable button
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    messageDiv.innerHTML = '';
    
    // Send AJAX request
    fetch('{% url "patients:patient_quick_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new patient to dropdown
            const select = document.getElementById('patient_select');
            const option = new Option(
                data.patient.patient_id + ' - ' + data.patient.name,
                data.patient.id,
                true,
                true
            );
            select.add(option);
            
            // Close modal
            const modalElement = document.getElementById('addPatientModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            
            // Reset form
            form.reset();
            messageDiv.innerHTML = '';
            
            // Show success message
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Patient added successfully!
                </div>
            `;
            
            // Alert user
            alert('Patient added successfully and selected!');
        } else {
            // Show error
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${data.error || 'Error creating patient. Please try again.'}
                </div>
            `;
        }
    })
    .catch(error => {
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Network error: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Patient';
    });
}

// Bill Calculation Functions
document.addEventListener('DOMContentLoaded', function() {
    const billItems = document.querySelectorAll('.bill-item');
    const amountPaidInput = document.getElementById('amount_paid');
    
    function formatCurrency(amount) {
        return '৳' + parseFloat(amount).toFixed(2);
    }
    
    function calculateTotal() {
        // Get all input values
        const consultation = parseFloat(document.getElementById('consultation_fee').value) || 0;
        const medicine = parseFloat(document.getElementById('medicine_charges').value) || 0;
        const lab = parseFloat(document.getElementById('lab_charges').value) || 0;
        const other = parseFloat(document.getElementById('other_charges').value) || 0;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const tax = parseFloat(document.getElementById('tax').value) || 0;
        
        // Calculate subtotal
        const subtotal = consultation + medicine + lab + other;
        
        // Calculate total
        const total = subtotal - discount + tax;
        
        // Update individual displays
        document.getElementById('consultation_display').textContent = formatCurrency(consultation);
        document.getElementById('medicine_display').textContent = formatCurrency(medicine);
        document.getElementById('lab_display').textContent = formatCurrency(lab);
        document.getElementById('other_display').textContent = formatCurrency(other);
        
        // Update summary displays
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('discount_display').textContent = '- ' + formatCurrency(discount);
        document.getElementById('tax_display').textContent = '+ ' + formatCurrency(tax);
        document.getElementById('total_amount').textContent = formatCurrency(total);
        
        // Update payment info (only for create form)
        const paidDisplay = document.getElementById('paid_display');
        const balanceDisplay = document.getElementById('balance_display');
        
        if (paidDisplay && balanceDisplay && amountPaidInput) {
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const balance = Math.max(0, total - amountPaid);
            
            paidDisplay.textContent = formatCurrency(amountPaid);
            balanceDisplay.textContent = formatCurrency(balance);
            
            // Set max value for amount_paid
            amountPaidInput.max = total;
            
            // Visual feedback
            if (balance === 0 && total > 0) {
                balanceDisplay.classList.remove('text-danger');
                balanceDisplay.classList.add('text-success');
            } else {
                balanceDisplay.classList.remove('text-success');
                balanceDisplay.classList.add('text-danger');
            }
        }
        
        // Visual feedback for amounts
        if (total > 0) {
            document.getElementById('total_amount').classList.remove('text-muted');
            document.getElementById('total_amount').classList.add('text-white');
        } else {
            document.getElementById('total_amount').classList.add('text-muted');
        }
    }
    
    // Add event listeners to all bill items
    billItems.forEach(item => {
        item.addEventListener('input', calculateTotal);
        item.addEventListener('change', calculateTotal);
    });
    
    // Add event listener to amount_paid
    if (amountPaidInput) {
        amountPaidInput.addEventListener('input', calculateTotal);
        amountPaidInput.addEventListener('change', calculateTotal);
    }
    
    // Initial calculation on page load
    calculateTotal();
    
    // Form validation
    document.getElementById('billForm').addEventListener('submit', function(e) {
        const total = parseFloat(document.getElementById('total_amount').textContent.replace('৳', '')) || 0;
        
        if (total <= 0) {
            e.preventDefault();
            alert('Bill total cannot be zero. Please enter valid amounts.');
            return false;
        }
        
        // Validate amount_paid
        if (amountPaidInput) {
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            if (amountPaid > total) {
                e.preventDefault();
                alert('Amount paid cannot exceed total amount!');
                return false;
            }
        }
        
        // Confirm submission
        if (!confirm('Are you sure you want to {% if is_update %}update{% else %}create{% endif %} this bill?')) {
            e.preventDefault();
            return false;
        }
    });
});
</script>

<style>
.bill-item:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.card-body small {
    font-size: 0.85rem;
}

.input-group .btn {
    white-space: nowrap;
}

.modal-header .btn-close-white {
    filter: brightness(0) invert(1);
}

@media print {
    .btn, nav, .card-header { display: none !important; }
}
</style>
{% endblock %}