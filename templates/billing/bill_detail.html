{% extends 'base.html' %}

{% block title %}Bill Details - {{ bill.bill_number }} - HMS{% endblock %}
{% block page_title %}Bill Details{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-file-invoice text-primary me-2"></i>
                Bill Details - {{ bill.bill_number }}
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'billing:bill_list' %}">Billing</a></li>
                    <li class="breadcrumb-item active">{{ bill.bill_number }}</li>
                </ol>
            </nav>
        </div>
        <div>
            <span class="badge bg-{{ bill.status|lower }} fs-5 px-3 py-2">
                {% if bill.status == 'PAID' %}
                    <i class="fas fa-check-circle me-1"></i> PAID
                {% elif bill.status == 'PARTIAL' %}
                    <i class="fas fa-exclamation-circle me-1"></i> PARTIAL
                {% else %}
                    <i class="fas fa-times-circle me-1"></i> UNPAID
                {% endif %}
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Bill Information Card -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Bill Information
                    </h5>
                    <span class="badge bg-white text-primary">{{ bill.bill_number }}</span>
                </div>
                <div class="card-body">
                    <!-- Patient Information -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-user me-2"></i>Patient Information
                            </h6>
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 60px; height: 60px; font-size: 24px;">
                                    {{ bill.patient.user.first_name.0|upper }}{{ bill.patient.user.last_name.0|upper }}
                                </div>
                                <div>
                                    <h5 class="mb-0">{{ bill.patient.get_full_name }}</h5>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-id-card me-1"></i>{{ bill.patient.patient_id }}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-envelope me-1"></i>{{ bill.patient.user.email }}
                                    </p>
                                    {% if bill.patient.phone_number %}
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-phone me-1"></i>{{ bill.patient.phone_number }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Bill Items -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-money-bill-wave me-2"></i>Bill Items
                    </h6>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <i class="fas fa-user-md text-primary me-2"></i>
                                        Consultation Fee
                                    </td>
                                    <td class="text-end">৳ {{ bill.consultation_fee|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-pills text-success me-2"></i>
                                        Medicine Charges
                                    </td>
                                    <td class="text-end">৳ {{ bill.medicine_charges|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-flask text-info me-2"></i>
                                        Lab Charges
                                    </td>
                                    <td class="text-end">৳ {{ bill.lab_charges|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-ellipsis-h text-warning me-2"></i>
                                        Other Charges
                                    </td>
                                    <td class="text-end">৳ {{ bill.other_charges|floatformat:2 }}</td>
                                </tr>
                                <tr class="table-light">
                                    <td><strong>Subtotal</strong></td>
                                    <td class="text-end">
                                        <strong>৳ {{ bill.subtotal|floatformat:2 }}</strong>
                                    </td>
                                </tr>
                                {% if bill.discount > 0 %}
                                <tr class="text-danger">
                                    <td>
                                        <i class="fas fa-percent me-2"></i>
                                        Discount
                                    </td>
                                    <td class="text-end">- ৳ {{ bill.discount|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                {% if bill.tax > 0 %}
                                <tr class="text-info">
                                    <td>
                                        <i class="fas fa-receipt me-2"></i>
                                        Tax
                                    </td>
                                    <td class="text-end">+ ৳ {{ bill.tax|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                <tr class="table-success">
                                    <td><strong><i class="fas fa-calculator me-2"></i>Total Amount</strong></td>
                                    <td class="text-end"><h4 class="mb-0 text-success">৳ {{ bill.total_amount|floatformat:2 }}</h4></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Additional Notes -->
                    {% if bill.notes %}
                    <hr>
                    <h6 class="text-primary mb-2">
                        <i class="fas fa-sticky-note me-2"></i>Additional Notes
                    </h6>
                    <div class="alert alert-info">
                        {{ bill.notes|linebreaks }}
                    </div>
                    {% endif %}

                    <!-- Timestamps -->
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Created: {{ bill.created_at|date:"M d, Y h:i A" }}
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                <i class="fas fa-sync me-1"></i>
                                Last Updated: {{ bill.updated_at|date:"M d, Y h:i A" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Summary Card -->
        <div class="col-lg-4 mb-4">
            <!-- Payment Status -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Payment Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Total Amount:</span>
                            <strong>৳ {{ bill.total_amount|floatformat:2 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Amount Paid:</span>
                            <strong class="text-success">৳ {{ bill.amount_paid|floatformat:2 }}</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span><strong>Balance Due:</strong></span>
                            <h5 class="mb-0 {% if bill.balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                ৳ {{ bill.balance|floatformat:2 }}
                            </h5>
                        </div>
                    </div>

                    {% if bill.status != 'PAID' %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Payment Pending:</strong> ৳ {{ bill.balance|floatformat:2 }}
                    </div>

                    <!-- Payment Form -->
                    <form method="post" action="{% url 'billing:record_payment' bill.pk %}" id="paymentForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Record Payment</label>
                            <input type="number" 
                                   name="payment_amount" 
                                   class="form-control" 
                                   step="0.01" 
                                   min="0.01" 
                                   max="{{ bill.balance }}"
                                   placeholder="Enter amount"
                                   required>
                            <small class="text-muted">Maximum: ৳{{ bill.balance|floatformat:2 }}</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check me-1"></i> Record Payment
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Fully Paid</strong>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'billing:bill_update' bill.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i> Edit Bill
                        </a>
                        <button onclick="printInvoice({{ bill.pk }})" class="btn btn-info">
                            <i class="fas fa-print me-1"></i> Print Invoice
                        </button>
                        <a href="{% url 'billing:bill_pdf' bill.pk %}" 
                           class="btn btn-danger" 
                           target="_blank">
                            <i class="fas fa-file-pdf me-1"></i> View Invoice
                        </a>
                        <a href="{% url 'billing:bill_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to List
                        </a>
                        <hr>
                        <button onclick="deleteBill()" class="btn btn-outline-danger">
                            <i class="fas fa-trash me-1"></i> Delete Bill
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
// Print Invoice Function
function printInvoice(billId) {
    // Open invoice in new window
    const printWindow = window.open(`/billing/${billId}/pdf/`, '_blank', 'width=800,height=600');
    
    // Wait for content to load, then print
    if (printWindow) {
        printWindow.onload = function() {
            printWindow.focus();
            printWindow.print();
        };
    } else {
        alert('Please allow pop-ups to print the invoice.');
    }
}

// Delete Bill Function
function deleteBill() {
    if (confirm('Are you sure you want to delete this bill? This action cannot be undone!')) {
        // Create a form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "billing:bill_delete" bill.pk %}';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Payment form validation
const paymentForm = document.getElementById('paymentForm');
if (paymentForm) {
    paymentForm.addEventListener('submit', function(e) {
        const amountInput = document.querySelector('input[name="payment_amount"]');
        const amount = parseFloat(amountInput.value);
        const balance = parseFloat('{{ bill.balance }}');
        
        if (amount > balance) {
            e.preventDefault();
            alert('Payment amount cannot exceed the balance due!');
            return false;
        }
        
        if (amount <= 0) {
            e.preventDefault();
            alert('Payment amount must be greater than zero!');
            return false;
        }
        
        return confirm('Record payment of ৳' + amount.toFixed(2) + '?');
    });
}
</script>

<style>
@media print {
    .btn, .card-header, nav, .breadcrumb, form, hr:last-of-type, .col-lg-4 {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .col-lg-8 {
        width: 100% !important;
    }
}

.badge.bg-paid {
    background-color: #28a745 !important;
}

.badge.bg-unpaid {
    background-color: #dc3545 !important;
}

.badge.bg-partial {
    background-color: #ffc107 !important;
    color: #000 !important;
}
</style>
{% endblock %}