{% extends 'base.html' %}

{% block title %}Attendance Reports - HMS{% endblock %}
{% block page_title %}Attendance Reports{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{% url 'attendance:attendance_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Attendance
        </a>
    </div>

    <!-- Report Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Report Filters
            </h5>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" name="report_type">
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly" selected>Monthly Report</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">From Date</label>
                        <input type="date" name="from_date" class="form-control" value="{{ from_date }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">To Date</label>
                        <input type="date" name="to_date" class="form-control" value="{{ to_date }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" name="department">
                            <option value="">All Departments</option>
                            <option value="medical">Medical</option>
                            <option value="nursing">Nursing</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="laboratory">Laboratory</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Generate Report
                    </button>
                    <button type="button" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button type="button" class="btn btn-danger">
                        <i class="fas fa-file-pdf me-2"></i>Export to PDF
                    </button>
                    <button type="button" class="btn btn-info" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-2 opacity-75">AVG ATTENDANCE</h6>
                            <h2 class="mb-0">{{ avg_attendance }}%</h2>
                            <small class="opacity-75">This month</small>
                        </div>
                        <i class="fas fa-chart-line fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-2 opacity-75">TOTAL PRESENT</h6>
                            <h2 class="mb-0">{{ total_present }}</h2>
                            <small class="opacity-75">Person-days</small>
                        </div>
                        <i class="fas fa-user-check fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-2 opacity-75">TOTAL ABSENT</h6>
                            <h2 class="mb-0">{{ total_absent }}</h2>
                            <small class="opacity-75">Person-days</small>
                        </div>
                        <i class="fas fa-user-times fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-2 opacity-75">LATE ARRIVALS</h6>
                            <h2 class="mb-0">{{ late_count|default:0 }}</h2>
                            <small class="opacity-75">This month</small>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department-wise Report -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="fas fa-building text-primary me-2"></i>Department-wise Attendance
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Department</th>
                            <th>Total Staff</th>
                            <th>Avg Present</th>
                            <th>Avg Absent</th>
                            <th>Attendance %</th>
                            <th>Late Count</th>
                            <th>On Leave</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept in department_stats %}
                        <tr>
                            <td><strong>{{ dept.name }}</strong></td>
                            <td>{{ dept.total_staff }}</td>
                            <td class="text-success"><strong>{{ dept.avg_present }}</strong></td>
                            <td class="text-danger">{{ dept.avg_absent }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        <div class="progress-bar {% if dept.attendance_percent >= 95 %}bg-success{% elif dept.attendance_percent >= 85 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             style="width: {{ dept.attendance_percent }}%">
                                            {{ dept.attendance_percent }}%
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>{{ dept.late_count }}</td>
                            <td>{{ dept.on_leave }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-3">No department data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if department_stats %}
                    <tfoot class="table-light">
                        <tr>
                            <td><strong>TOTAL</strong></td>
                            <td><strong>{{ total_staff }}</strong></td>
                            <td class="text-success"><strong>{{ total_present_avg }}</strong></td>
                            <td class="text-danger"><strong>{{ total_absent_avg }}</strong></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: {{ avg_attendance }}%">
                                            <strong>{{ avg_attendance }}%</strong>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td><strong>{{ total_late }}</strong></td>
                            <td><strong>{{ total_on_leave }}</strong></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- Individual Employee Report -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-users text-success me-2"></i>Individual Employee Report
            </h5>
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" placeholder="Search employee..." id="searchInput">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="employeeTable">
                    <thead class="table-light">
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Working Days</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Late</th>
                            <th>On Leave</th>
                            <th>Attendance %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in employee_stats %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle text-white me-2" 
                                         style="width: 35px; height: 35px; border-radius: 50%; 
                                                display: flex; align-items: center; justify-content: center; 
                                                font-size: 14px; font-weight: bold;
                                                background: {% cycle '#28a745' '#007bff' '#ffc107' '#dc3545' '#17a2b8' %};">
                                        {{ emp.employee.user.first_name.0|upper }}{{ emp.employee.user.last_name.0|upper }}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ emp.employee.user.get_full_name }}</div>
                                        <small class="text-muted">{{ emp.employee.employee_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ emp.employee.department|default:"N/A" }}</span>
                            </td>
                            <td>{{ emp.working_days }}</td>
                            <td class="text-success"><strong>{{ emp.present_days }}</strong></td>
                            <td class="text-danger">{{ emp.absent_days }}</td>
                            <td class="text-warning">{{ emp.late_days }}</td>
                            <td>{{ emp.leave_days }}</td>
                            <td>
                                <span class="badge {% if emp.attendance_percent >= 95 %}bg-success{% elif emp.attendance_percent >= 85 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ emp.attendance_percent }}%
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>No employee data available
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchValue = this.value.toLowerCase();
    const table = document.getElementById('employeeTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        
        if (text.includes(searchValue)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
});
</script>
{% endblock %}